# 网关对象，自己实现一个网关
一个基本的需求：
最简单的需求：
访问网关->执行拦截操作->获取配置信息->根据配置判断代理类型->连接到不同机器上->获取代理结果->返回->转发到target->代理后处理相关响应信息

基本思路：

获取请求->获取代理配置->限流->反爬虫->鉴权->返回响应

怎么扩容？怎么控制集群呢？网关怎么大规模部署呢


1. 监控
2. 健康监测
3. 失败切换
4. 失败移除指定机器
5. 分布式怎么限流嘞：通过redis，不要怕访问redis慢

负载均衡怎么实现?怎么知道上次请求了哪台机器？
健康监测怎么实现呢？ 由几台机器专门负责监测？
怎么失败自动切换嘞

机器多的时候怎么确保每台机器都能独立处理请求呢

怎么知道上次请求了哪台机器呢？放内存里面吧

首先每台机器都持有一个连接池，用来连接主机


 需要持有api配置到
 
 如果代理http请求的话，是不需要将http请求聚合到一起的，只有需要解析http请求的时候才需要聚合
 
# 连接池设计与channel
连接池管理：
连接池应该是根据某一个条件获取连接信息，应该是单一职责的，而Channel是通道，失败后可以重新获取连接，获取到的连接可以
放到连接池里面，从这点上来看，职责是不一致的
连接池应该有哪些职责呢？
1. 根据地址获取连接
2. 将连接放回到连接池
3. 移除连接
4. 是否需要对持有的连接进行健康检查呢？还是可以只在获取的时候处理呢。
5. 连接池是只持有连接呢，还是把建立连接的操作也做了呢？ 感觉好像如果只是一个地址的话，仅仅建立连接就行了吧。要是有多个连接，还是外部负责
建立连接？ 建立几个连接呢？ 怎么处理连接的问题呢

dubbo rpc协议建立了几个连接呢？jdbc又建立了几个连接？ 
怎么判断该建立几个连接呢？

非netty怎么处理异步编程呢？ 
## 连接建立方式
dubbo 好像是根据connections决定建立几个连接

连接关闭的的几种方式：
* Connection:close
* 空闲超时，关闭连接
* 读超时关闭连接
* 写超时，关闭连接
* Fin,Reset
* 异常时

zuul持有状态的逻辑 vs 我持有状态的逻辑 
有什么区别呢？

# loadbalance设计思路
LoadBalance应该是与具体某个客户端绑定的，LoadBalance本身只用来选择服务器，并不与具体的服务绑定到一起
LoadBalance是某个客户端域名下的所有接口都可以出来，但是针对某个接口怎么单独鉴权呢，针对某个接口怎么单独授予流量呢
其实没有本质区别，针对还是每个接口都注册一下就好了嘛,在更高层面上把这种差异屏蔽掉，同时也能提高调用效率


# 应用整体流程
建立服务端连接->接收请求->执行过滤->获取代理后的请求（jsf or http） -> 获取服务列表 -> 负载均衡 -> 连接客户端 -> 失败重试
->再失败更换 -> 连接成功 -> 发送请求 -> 请求关闭 -> 关闭后释放连接

设计思路的扭转：
与客户端有关的配置应该放到一个总的类里面，这样关联的负载均衡、获取服务器、创建代理等操作就不用再重新创建一个新类了
而且根据单一职责原理，每个类职责应该是单一的，这样才能处理

负载均衡对象创建放到ClientOrigin里持有合适吗？ 不太合适，负载均衡是伴随着连接去创立的，若连接都没有创建，持有负载均衡是不合适的吧

# 业务逻辑的设计
需要不仅仅考虑拦截器，看看能不能与状态机结合到一起呢？ 还有jsf协议怎么适配呢。有一点可以确定，zuul2.0的过滤器设计和路由设计真的是有点一言难尽

应该是根据逻辑判断是否需要进行http聚集操作，若需要，则进行聚集操作，否则，不聚集

* 客户端定期发送ping请求到服务端，定期进行健康检查操作

# 如何进行数据统计呢？

熔断设计：要考虑熔断，首先要对那些接口需要熔断进行出来

# 实时监控可以使用Metrics来出来，历史监控日志怎么分析呢？
怎么保存历史监控信息？ 
首先需要一个collector将所有的日志信息存储起来，然后通过工具分析这些日志。
数据库存储肯定是不太靠谱的，因此数据库可伸缩性有问题，用什么东西去存储这些信息呢？   
可以使用OpenTSDB作为存储引擎， OpenTsDB的原理是怎样的呢？ 


还要有trace跟踪呢

每个请求都要有一个stat统计信息

连接池是按服务来呢还是按主机来呢？
但是要是按主机来的话怎么平衡各个服务间的平衡关系呢？

怎么做资源隔离呢？怎么确保每个服务用到的资源不会超负荷呢


# 问题列表
autoRead没有设置导致读取不到响应内容的问题？哈哈哈哈

服务端超时处理：客户端超时处理，等等，这些都需要考虑呢

# 网关健康检查
是不是没有必要进行健康检查了，要是服务很多的话，检查的过来吗，是不是可以参考一下dubbo这一块是怎么做的
可以有主动健康检查与被动健康检查吗

# 连接失败后的策略
连接失败的话是继续重试呢还是选择另一个服务器？
这样吧，服务器有熔断策略，一段时间连接不上的话就变成非active,定期对非active的服务器进行检查。

熔断策略：在指定的时间内错误指定的次数即可，错误要是连接错误、读超时或者写超时

还要选择leader吗？暂时先别拉，看看别的怎么做的 



